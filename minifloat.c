/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */


#include "minifloat.h"

#if 1
    #define F2M_NAN 128
    #define F2M_INF 127
    #define F2M_NINF 255

    #define MAXFLOAT 10000
    #define MINFLOAT -10000
#else
    #define F2M_NAN 255
    #define F2M_INF 120
    #define F2M_NINF 248

    #define MAXFLOAT 122880
    #define MINFLOAT -122880
#endif

const unsigned int FLOAT8MAP[256] ={0x00000000,0x3883126f,0x3903126f,0x39449ba6,0x3983126f,0x39a3d70a,0x39c49ba6,0x39e56042,
                                0x3a03126f,0x3a1374bc,0x3a23d70a,0x3a343958,0x3a449ba6,0x3a54fdf4,0x3a656042,0x3a75c28f,
                                0x3aa3d70a,0x3af5c28f,0x3b23d70a,0x3b4ccccd,0x3b75c28f,0x3b8f5c29,0x3ba3d70a,0x3bb851ec,
                                0x3bcccccd,0x3be147ae,0x3bf5c28f,0x3c051eb8,0x3c0f5c29,0x3c19999a,0x3c23d70a,0x3c2e147b,
                                0x3c4ccccd,0x3c99999a,0x3ccccccd,0x3d000000,0x3d19999a,0x3d333333,0x3d4ccccd,0x3d666666,
                                0x3d800000,0x3d8ccccd,0x3d99999a,0x3da66666,0x3db33333,0x3dc00000,0x3dcccccd,0x3dd9999a,
                                0x3e000000,0x3e400000,0x3e800000,0x3ea00000,0x3ec00000,0x3ee00000,0x3f000000,0x3f100000,
                                0x3f200000,0x3f300000,0x3f400000,0x3f500000,0x3f600000,0x3f700000,0x3f800000,0x3f880000,
                                0x3fa00000,0x3ff00000,0x40200000,0x40480000,0x40700000,0x408c0000,0x40a00000,0x40b40000,
                                0x40c80000,0x40dc0000,0x40f00000,0x41020000,0x410c0000,0x41160000,0x41200000,0x412a0000,
                                0x41480000,0x41960000,0x41c80000,0x41fa0000,0x42160000,0x422f0000,0x42480000,0x42610000,
                                0x427a0000,0x42898000,0x42960000,0x42a28000,0x42af0000,0x42bb8000,0x42c80000,0x42d48000,
                                0x42fa0000,0x433b8000,0x437a0000,0x439c4000,0x43bb8000,0x43dac000,0x43fa0000,0x440ca000,
                                0x441c4000,0x442be000,0x443b8000,0x444b2000,0x445ac000,0x446a6000,0x447a0000,0x4484d000,
                                0x449c4000,0x44ea6000,0x451c4000,0x45435000,0x456a6000,0x4588b800,0x459c4000,0x45afc800,
                                0x45c35000,0x45d6d800,0x45ea6000,0x45fde800,0x4608b800,0x46127c00,0x461c4000,0xff800000,

                                0x7fffffff,0xb883126f,0xb903126f,0xb9449ba6,0xb983126f,0xb9a3d70a,0xb9c49ba6,0xb9e56042,
                                0xba03126f,0xba1374bc,0xba23d70a,0xba343958,0xba449ba6,0xba54fdf4,0xba656042,0xba75c28f,
                                0xbaa3d70a,0xbaf5c28f,0xbb23d70a,0xbb4ccccd,0xbb75c28f,0xbb8f5c29,0xbba3d70a,0xbbb851ec,
                                0xbbcccccd,0xbbe147ae,0xbbf5c28f,0xbc051eb8,0xbc0f5c29,0xbc19999a,0xbc23d70a,0xbc2e147b,
                                0xbc4ccccd,0xbc99999a,0xbccccccd,0xbd000000,0xbd19999a,0xbd333333,0xbd4ccccd,0xbd666666,
                                0xbd800000,0xbd8ccccd,0xbd99999a,0xbda66666,0xbdb33333,0xbdc00000,0xbdcccccd,0xbdd9999a,
                                0xbe000000,0xbe400000,0xbe800000,0xbea00000,0xbec00000,0xbee00000,0xbf000000,0xbf100000,
                                0xbf200000,0xbf300000,0xbf400000,0xbf500000,0xbf600000,0xbf700000,0xbf800000,0xbf880000,
                                0xbfa00000,0xbff00000,0xc0200000,0xc0480000,0xc0700000,0xc08c0000,0xc0a00000,0xc0b40000,
                                0xc0c80000,0xc0dc0000,0xc0f00000,0xc1020000,0xc10c0000,0xc1160000,0xc1200000,0xc12a0000,
                                0xc1480000,0xc1960000,0xc1c80000,0xc1fa0000,0xc2160000,0xc22f0000,0xc2480000,0xc2610000,
                                0xc27a0000,0xc2898000,0xc2960000,0xc2a28000,0xc2af0000,0xc2bb8000,0xc2c80000,0xc2d48000,
                                0xc2fa0000,0xc33b8000,0xc37a0000,0xc39c4000,0xc3bb8000,0xc3dac000,0xc3fa0000,0xc40ca000,
                                0xc41c4000,0xc42be000,0xc43b8000,0xc44b2000,0xc45ac000,0xc46a6000,0xc47a0000,0xc484d000,
                                0xc49c4000,0xc4ea6000,0xc51c4000,0xc5435000,0xc56a6000,0xc588b800,0xc59c4000,0xc5afc800,
                                0xc5c35000,0xc5d6d800,0xc5ea6000,0xc5fde800,0xc608b800,0xc6127c00,0xc61c4000,0x7f800000};

const float PFLOAT8MAP[256]= {  0.00000000,0.00006250,0.00012500,0.00018750,0.00025000,0.00031250,0.00037500,0.00043750,
                                0.00050000,0.00056250,0.00062500,0.00068750,0.00075000,0.00081250,0.00087500,0.00093750,
                                0.00125000,0.00187500,0.00250000,0.00312500,0.00375000,0.00437500,0.00500000,0.00562500,
                                0.00625000,0.00687500,0.00750000,0.00812500,0.00875000,0.00937500,0.01000000,0.01062500,
                                0.01250000,0.01875000,0.02500000,0.03125000,0.03750000,0.04375000,0.05000000,0.05625000,
                                0.06250000,0.06875000,0.07500000,0.08125000,0.08750000,0.09375000,0.10000000,0.10625000,
                                0.12500000,0.18750000,0.25000000,0.31250000,0.37500000,0.43750000,0.50000000,0.56250000,
                                0.62500000,0.68750000,0.75000000,0.81250000,0.87500000,0.93750000,1.00000000,1.06250000,
                                1.25000000,1.87500000,2.50000000,3.12500000,3.75000000,4.37500000,5.00000000,5.62500000,
                                6.25000000,6.87500000,7.50000000,8.12500000,8.75000000,9.37500000,10.00000000,10.62500000,
                                12.50000000,18.75000000,25.00000000,31.25000000,37.50000000,43.75000000,50.00000000,56.25000000,
                                62.50000000,68.75000000,75.00000000,81.25000000,87.50000000,93.75000000,100.00000000,106.25000000,
                                125.00000000,187.50000000,250.00000000,312.50000000,375.00000000,437.50000000,500.00000000,562.50000000,
                                625.00000000,687.50000000,750.00000000,812.50000000,875.00000000,937.50000000,1000.00000000,1062.50000000,
                                1250.00000000,1875.00000000,2500.00000000,3125.00000000,3750.00000000,4375.00000000,5000.00000000,5625.00000000,
                                6250.00000000,6875.00000000,7500.00000000,8125.00000000,8750.00000000,9375.00000000,10000.00000000,10625.00000000};

const float FLOAT8MAPOLD[256] = {0,1,2,3,4,5,6,7,
                            8,9,10,11,12,13,14,15,
                            16,18,20,22,24,26,28,30,
                            32,36,40,44,48,52,56,60,
                            64,72,80,88,96,104,112,120,
                            128,144,160,176,192,208,224,240,
                            256,288,320,352,384,416,448,480,
                            512,576,640,704,768,832,896,960,
                            1024,1152,1280,1408,1536,1664,1792,1920,
                            2048,2304,2560,2816,3072,3328,3584,3840,
                            4096,4608,5120,5632,6144,6656,7168,7680,
                            8192,9216,10240,11264,12288,13312,14336,15360,
                            16384,18432,20480,22528,24576,26624,28672,30720,
                            32768,36864,40960,45056,49152,53248,57344,61440,
                            65536,73728,81920,90112,98304,106496,114688,122880,
                            0x7f800000,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,
                            -0,-1,-2,-3,-4,-5,-6,-7,
                            -8,-9,-10,-11,-12,-13,-14,-15,
                            -16,-18,-20,-22,-24,-26,-28,-30,
                            -32,-36,-40,-44,-48,-52,-56,-60,
                            -64,-72,-80,-88,-96,-104,-112,-120,
                            -128,-144,-160,-176,-192,-208,-224,-240,
                            -256,-288,-320,-352,-384,-416,-448,-480,
                            -512,-576,-640,-704,-768,-832,-896,-960,
                            -1024,-1152,-1280,-1408,-1536,-1664,-1792,-1920,
                            -2048,-2304,-2560,-2816,-3072,-3328,-3584,-3840,
                            -4096,-4608,-5120,-5632,-6144,-6656,-7168,-7680,
                            -8192,-9216,-10240,-11264,-12288,-13312,-14336,-15360,
                            -16384,-18432,-20480,-22528,-24576,-26624,-28672,-30720,
                            -32768,-36864,-40960,-45056,-49152,-53248,-57344,-61440,
                            -65536,-73728,-81920,-90112,-98304,-106496,-114688,-122880,
                            0xff800000,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff};


const unsigned int FLOAT8MAPX[256] = {0x00000000,0x3f800000,0x40000000,0x40400000,0x40800000,0x40a00000,0x40c00000,0x40e00000,
                                     0x41000000,0x41100000,0x41200000,0x41300000,0x41400000,0x41500000,0x41600000,0x41700000,
                                     0x41800000,0x41900000,0x41a00000,0x41b00000,0x41c00000,0x41d00000,0x41e00000,0x41f00000,
                                     0x42000000,0x42100000,0x42200000,0x42300000,0x42400000,0x42500000,0x42600000,0x42700000,
                                     0x42800000,0x42900000,0x42a00000,0x42b00000,0x42c00000,0x42d00000,0x42e00000,0x42f00000,
                                     0x43000000,0x43100000,0x43200000,0x43300000,0x43400000,0x43500000,0x43600000,0x43700000,
                                     0x43800000,0x43900000,0x43a00000,0x43b00000,0x43c00000,0x43d00000,0x43e00000,0x43f00000,
                                     0x44000000,0x44100000,0x44200000,0x44300000,0x44400000,0x44500000,0x44600000,0x44700000,
                                     0x44800000,0x44900000,0x44a00000,0x44b00000,0x44c00000,0x44d00000,0x44e00000,0x44f00000,
                                     0x45000000,0x45100000,0x45200000,0x45300000,0x45400000,0x45500000,0x45600000,0x45700000,
                                     0x45800000,0x45900000,0x45a00000,0x45b00000,0x45c00000,0x45d00000,0x45e00000,0x45f00000,
                                     0x46000000,0x46100000,0x46200000,0x46300000,0x46400000,0x46500000,0x46600000,0x46700000,
                                     0x46800000,0x46900000,0x46a00000,0x46b00000,0x46c00000,0x46d00000,0x46e00000,0x46f00000,
                                     0x47000000,0x47100000,0x47200000,0x47300000,0x47400000,0x47500000,0x47600000,0x47700000,
                                     0x47800000,0x47900000,0x47a00000,0x47b00000,0x47c00000,0x47d00000,0x47e00000,0x47f00000,
                                     0xff800000,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,
                                     0x80000000,0xbf800000,0xc0000000,0xc0400000,0xc0800000,0xc0a00000,0xc0c00000,0xc0e00000,
                                     0xc1000000,0xc1100000,0xc1200000,0xc1300000,0xc1400000,0xc1500000,0xc1600000,0xc1700000,
                                     0xc1800000,0xc1900000,0xc1a00000,0xc1b00000,0xc1c00000,0xc1d00000,0xc1e00000,0xc1f00000,
                                     0xc2000000,0xc2100000,0xc2200000,0xc2300000,0xc2400000,0xc2500000,0xc2600000,0xc2700000,
                                     0xc2800000,0xc2900000,0xc2a00000,0xc2b00000,0xc2c00000,0xc2d00000,0xc2e00000,0xc2f00000,
                                     0xc3000000,0xc3100000,0xc3200000,0xc3300000,0xc3400000,0xc3500000,0xc3600000,0xc3700000,
                                     0xc3800000,0xc3900000,0xc3a00000,0xc3b00000,0xc3c00000,0xc3d00000,0xc3e00000,0xc3f00000,
                                     0xc4000000,0xc4100000,0xc4200000,0xc4300000,0xc4400000,0xc4500000,0xc4600000,0xc4700000,
                                     0xc4800000,0xc4900000,0xc4a00000,0xc4b00000,0xc4c00000,0xc4d00000,0xc4e00000,0xc4f00000,
                                     0xc5000000,0xc5100000,0xc5200000,0xc5300000,0xc5400000,0xc5500000,0xc5600000,0xc5700000,
                                     0xc5800000,0xc5900000,0xc5a00000,0xc5b00000,0xc5c00000,0xc5d00000,0xc5e00000,0xc5f00000,
                                     0xc6000000,0xc6100000,0xc6200000,0xc6300000,0xc6400000,0xc6500000,0xc6600000,0xc6700000,
                                     0xc6800000,0xc6900000,0xc6a00000,0xc6b00000,0xc6c00000,0xc6d00000,0xc6e00000,0xc6f00000,
                                     0xc7000000,0xc7100000,0xc7200000,0xc7300000,0xc7400000,0xc7500000,0xc7600000,0xc7700000,
                                     0xc7800000,0xc7900000,0xc7a00000,0xc7b00000,0xc7c00000,0xc7d00000,0xc7e00000,0xc7f00000,
                                     0xff800000,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff,0x7fffffff};

const float PFLOAT8MAPX[120] = {0,1,2,3,4,5,6,7,
                               8,9,10,11,12,13,14,15,
                               16,18,20,22,24,26,28,30,
                               32,36,40,44,48,52,56,60,
                               64,72,80,88,96,104,112,120,
                               128,144,160,176,192,208,224,240,
                               256,288,320,352,384,416,448,480,
                               512,576,640,704,768,832,896,960,
                               1024,1152,1280,1408,1536,1664,1792,1920,
                               2048,2304,2560,2816,3072,3328,3584,3840,
                               4096,4608,5120,5632,6144,6656,7168,7680,
                               8192,9216,10240,11264,12288,13312,14336,15360,
                               16384,18432,20480,22528,24576,26624,28672,30720,
                               32768,36864,40960,45056,49152,53248,57344,61440,
                               65536,73728,81920,90112,98304,106496,114688,122880};

float mini_to_float(unsigned char mini){
    //printf("Mini: %d\n",mini);
    return *(float*)(FLOAT8MAP+mini);
}

/*
void print_float_map(){
    float lVal;
    float lCVal;
    int lConv;
    for(int i = 0; i < 256; i++){
        //lVal = FLOAT8MAP[i];
        lVal = FLOAT8MAPNEW[i];
        lConv = *(int*)(&lVal);
        lCVal = *(float*)(&lConv);
        //printf("%u %f %f | %x\n",i,lVal,lCVal,lConv);
        printf("%u 0x%x\n",i,lConv);
    }
}
*/

unsigned char bin_search(float floatVal){
    
    unsigned char index = 63;
    unsigned char left = 0;
    unsigned char right = 126;
    float dl = 0;
    float dr = 0;
    while(right > left){

        if(floatVal<=PFLOAT8MAP[index+1] && floatVal>=PFLOAT8MAP[index]){
            dr = PFLOAT8MAP[index+1]-floatVal;
            dl = floatVal-PFLOAT8MAP[index];
            left = index;
            right = index;
        } else {
            if(PFLOAT8MAP[index]>=floatVal){
                right = index;
                index = left + (right-left)/2;
            } else {
                left = index;
                index = left + (right-left)/2;
            }

        }
        
    }
    
    if(dl>dr){
        index++;
    }
    
    return index;
    
}

unsigned char float_to_mini(float floatVal){

    if(isnan(floatVal)){
        return F2M_NAN;
    } else if(floatVal > MAXFLOAT){
        return F2M_INF;
    } else if(floatVal < MINFLOAT){
        return F2M_NINF;
    } else if(floatVal<0){
        return bin_search(-floatVal)+128;
    } else {
        return bin_search(floatVal);
    }
    
    return F2M_NAN;
}

bool isNan(unsigned char mini){
    return mini == F2M_NAN;
}

bool isInf(unsigned char mini){
    return (mini == F2M_INF || mini == F2M_NINF);
}